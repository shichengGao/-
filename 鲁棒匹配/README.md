# RANSAC鲁棒匹配

​	这个程序的目标是从图像中提取特征点，然后经过鲁棒估计来获得它们之间的匹配关系(这里是单应矩阵H)，用来鲁棒估计的算法就是RANSAC。

## 1.随机一致性采样(RANSAC)

​	RANSAC是一种迭代式的鲁棒参数估计方法，和最小二乘法不同，RANSAC不会把所有的点都计入估计，而是会把点集分为内点(inliers)和外点(outliers)，外点通常就是离群点，而内点则是符合当前参数估计的数据点，RANSAC流程大体如下：

1. ​	从数据点集合中采样一组点，点的数量要能够估计目标参数，对于二维直线的估计需要两个点，而估计单应矩阵就需要四对匹配点。
2. 根据采样点集计算模型参数。
3. 计算所有数据点与估计模型的误差，误差大于预定阈值的算作outllier，其余为inliners。
4. 重复步骤1～3来迭代，每次更新内点最多的模型参数，当模型足够准确或到达最大迭代次数后停止迭代。

## 2.鲁棒估计Homography

### 	2.1四点法估计单应矩阵H(参考SLAM十四讲第7讲)

​		在使用RANSAC估计单应矩阵之前，还需要使用匹配点对估计参数，这里就需要**四点法**估计，对于一个单应矩阵H：
$$
H = \begin{aligned}\begin{bmatrix} h_1 & h_2 & h_3 \\ h_4 & h_5 & h_6 \\ h_7 & h_8 &h_9 \end{bmatrix}\end{aligned}
$$
有如下的点对变换关系，$(u_1,v_1)$和$(u_2,v_2)$分别是原点和目标点：
$$
\begin{bmatrix}u_2 \\ v_1 \\ 1 \end{bmatrix} = \begin{aligned}\begin{bmatrix} h_1 & h_2 & h_3 \\ h_4 & h_5 & h_6 \\ h_7 & h_8 &h_9 \end{bmatrix}\end{aligned}\begin{bmatrix}u_1 \\ v_1 \\ 1 \end{bmatrix}
$$
​	

​	除了$h_9$可以直接取1，H矩阵共有8个自由度，每一对匹配点可以构造出两项约束，所以，在非退化情况下，共需要四对匹配来估计一个单应矩阵，所以使用直接线性变换(DLT)方法，就有如下的线性方程组：
$$
\begin{aligned}\begin{bmatrix}   u_1^1 & v_1^1 & 1 & 0 & 0 & 0 & -u_1^1u_2^1 & -v_1^1u_2^1 \\
								0 & 0 & 0 & u_1^1 &v_1^1 & 1 & -u_1^1v_2^1 & -v_1^1v_2^1 \\ 
							    u_1^2 & v_1^2 & 1 & 0 & 0 & 0 & -u_1^2u_2^2 & -v_1^2u_2^2 \\
								0 & 0 & 0 & u_1^2 &v_1^2 & 1 & -u_1^2v_2^2 & -v_1^2v_2^2 \\ 
								 u_1^3 & v_1^3 & 1 & 0 & 0 & 0 & -u_1^3u_2^3 & -v_1^3u_2^3 \\
								0 & 0 & 0 & u_1^3 &v_1^3 & 1 & -u_1^3v_2^3 & -v_1^3v_2^3 \\ 
								 u_1^4 & v_1^4 & 1 & 0 & 0 & 0 & -u_1^4u_2^4 & -v_1^4u_2^4 \\
								0 & 0 & 0 & u_1^4 &v_1^4 & 1 & -u_1^4v_2^4 & -v_1^4v_2^4 \\ 
								
\end{bmatrix}\end{aligned}
\begin{bmatrix} h_1 \\ h_2 \\h_3 \\h_4 \\h_5 \\h_6 \\h_7 \\h_8 \end{bmatrix}
= \begin{bmatrix} u_2^1 \\ v_2^1 \\u_2^2 \\ v_2^2 \\u_2^3 \\ v_2^3 \\u_2^4 \\ v_2^4 \end{bmatrix}
$$
解该方程组就可获得一个H矩阵的八个参数。

### 2.2 RANSAC部分

​	现在事情就变得清晰明了了，程序首先调用opencv库的SIFT特征提取和KNN匹配，然后开始RANSAC获取H矩阵，每次迭代挑选4组匹配点，使用四点法获取H后用该H算出源点经变换后的目标点，计算重投影误差（程序是按欧式距算的）并筛选inliers和outliers，直到达到迭代条件。

​	细节详见findHomography_RANSAC函数。

